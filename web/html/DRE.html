<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRE — Demonstrativo de Resultado do Exercício</title>

  <!-- Estilo: limpo, alinhado ao visual soft/shadow do projeto -->
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0f172a;
      --accent-2:#0ea5a0;
      --success:#059669;
      --danger:#dc2626;
      --shadow: 0 8px 20px rgba(15,23,42,0.06);
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      background:linear-gradient(180deg, var(--bg), #eef2f6);
      color:var(--accent);
    }

    .container{
      max-width:1100px;
      margin:36px auto;
      padding:20px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:18px;
    }

    header h1{
      margin:0 0 6px 0;
      font-size:20px;
      letter-spacing:-0.2px;
    }
    header p{ margin:0; color:var(--muted); font-size:13px }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:14px;
      flex-wrap:wrap;
    }

    input[type="number"], select {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      min-width:110px;
      font-size:14px;
      background:#fbfcfe;
    }

    button{
      background:linear-gradient(180deg,var(--accent-2),#089d97);
      border:none;
      color:white;
      padding:9px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 6px 14px rgba(14,165,160,0.12);
    }
    button.secondary{
      background:transparent;
      color:var(--accent);
      border:1px solid #e6e9ef;
      box-shadow:none;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
    }

    /* tabela */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th {
      text-align:left;
      padding:12px 10px;
      font-weight:700;
      font-size:13px;
      color:var(--muted);
      border-bottom:1px solid #eef2f6;
      background:transparent;
    }
    tbody td {
      padding:10px;
      border-bottom:1px solid #f3f6fa;
    }
    tbody tr:hover { background: #fbfeff; }

    .muted { color:var(--muted); font-size:13px; }

    .summary {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      border-radius:10px;
      background:#fbfcfe;
      border:1px solid #eef2f6;
    }
    .summary .result{
      font-size:18px;
      font-weight:700;
    }

    .empty{
      padding:18px;
      text-align:center;
      color:var(--muted);
    }

    .small { font-size:13px; color:var(--muted); }

    /* responsivo */
    @media (max-width:980px){
      .grid{ grid-template-columns: 1fr; }
      .controls{ gap:8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>Demonstrativo de Resultado do Exercício (DRE)</h1>
        <p>Gere o DRE com base nos lançamentos cadastrados no sistema. Os valores são retirados da rota <code>/dre/:ano/:mes?</code>.</p>
      </header>

      <div class="controls" style="margin-top:12px;">
        <label class="small">Ano
          <input id="input-ano" type="number" min="2000" max="2100" value="" placeholder="2025" />
        </label>

        <label class="small">Mês (opcional)
          <select id="input-mes">
            <option value="">— Todos —</option>
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </label>

        <button id="btn-gerar">Gerar DRE</button>
        <button id="btn-export" class="secondary" title="Exportar CSV">Exportar CSV</button>

        <div style="margin-left:auto; text-align:right;">
          <div class="small muted">Última atualização: <span id="last-updated">—</span></div>
          <div class="small muted">Fonte: lançamentos e plano de contas</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card" style="min-height:320px;">
        <div id="table-wrapper">
          <table aria-describedby="dre-table">
            <thead>
              <tr>
                <th style="width:130px">Código</th>
                <th>Descrição</th>
                <th style="width:150px; text-align:right">Valor (R$)</th>
                <th style="width:140px">Grupo</th>
              </tr>
            </thead>
            <tbody id="dre-tbody">
              <tr><td colspan="4" class="empty">Clique em <strong>Gerar DRE</strong> para carregar os dados do servidor.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <aside class="card">
        <div class="summary">
          <div class="item">
            <div class="muted">Total Receitas</div>
            <div id="total-receitas">R$ 0,00</div>
          </div>
          <div class="item">
            <div class="muted">Total Despesas</div>
            <div id="total-despesas">R$ 0,00</div>
          </div>
          <div class="item" style="background:linear-gradient(180deg,#f8fff6,#f0fff0); border-color:#e6f6ea;">
            <div class="muted">Resultado (Lucro/Prejuízo)</div>
            <div id="resultado" class="result">R$ 0,00</div>
          </div>

          <div style="margin-top:8px; font-size:13px;" class="muted">
            Observações:
            <ul style="margin:6px 0 0 18px; padding:0;">
              <li>O DRE é gerado dinamicamente com base nas contas que possuem classificação <code>dre_grupo</code>.</li>
              <li>Os valores vêm dos lançamentos agregados por conta (API).</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Script: Fetch e renderização -->
  <script>
    (function(){
      const btnGerar = document.getElementById('btn-gerar');
      const btnExport = document.getElementById('btn-export');
      const tbody = document.getElementById('dre-tbody');
      const lastUpdated = document.getElementById('last-updated');

      const totalReceitasEl = document.getElementById('total-receitas');
      const totalDespesasEl = document.getElementById('total-despesas');
      const resultadoEl = document.getElementById('resultado');

      const inputAno = document.getElementById('input-ano');
      const inputMes = document.getElementById('input-mes');

      // Preencher ano atual por conveniência
      const now = new Date();
      if (!inputAno.value) inputAno.value = now.getFullYear();

      // Helper: formata número para R$
      function formatMoney(v){
        const n = Number(v || 0);
        return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
      }

      // Renderiza linhas (espera o JSON retornado pelo endpoint /dre/:ano/:mes)
      function renderDRE(json){
        // json deve ter: ano, mes, linhas: [{codigo, descricao, valor, grupo}]
        tbody.innerHTML = '';
        if (!json || !Array.isArray(json.linhas) || json.linhas.length === 0){
          tbody.innerHTML = '<tr><td colspan="4" class="empty">Nenhuma linha encontrada para esse período.</td></tr>';
          totalReceitasEl.textContent = formatMoney(0);
          totalDespesasEl.textContent = formatMoney(0);
          resultadoEl.textContent = formatMoney(0);
          return;
        }

        // ordenar: receitas acima das despesas (opcional). Mantemos a ordem do serviço.
        let receitasTotal = 0;
        let despesasTotal = 0;

        json.linhas.forEach(l => {
          const tr = document.createElement('tr');

          const tdCodigo = document.createElement('td');
          tdCodigo.textContent = l.codigo || '';
          tdCodigo.className = 'muted';
          tr.appendChild(tdCodigo);

          const tdDesc = document.createElement('td');
          tdDesc.textContent = l.descricao || '';
          tr.appendChild(tdDesc);

          const tdValor = document.createElement('td');
          tdValor.style.textAlign = 'right';
          tdValor.textContent = formatMoney(l.valor || 0);
          tr.appendChild(tdValor);

          const tdGrupo = document.createElement('td');
          tdGrupo.textContent = l.grupo || '';
          tdGrupo.className = 'muted';
          tr.appendChild(tdGrupo);

          tbody.appendChild(tr);

          if ((l.grupo || '').toUpperCase() === 'RECEITAS') receitasTotal += Number(l.valor || 0);
          else if ((l.grupo || '').toUpperCase() === 'DESPESAS') despesasTotal += Number(l.valor || 0);
        });

        totalReceitasEl.textContent = formatMoney(receitasTotal);
        totalDespesasEl.textContent = formatMoney(despesasTotal);
        resultadoEl.textContent = formatMoney(receitasTotal - despesasTotal);

        lastUpdated.textContent = new Date().toLocaleString();
      }

      // Faz fetch para API /dre/:ano/:mes?
      async function fetchDRE(ano, mes){
        if (!ano) {
          alert('Informe o ano para gerar o DRE.');
          return;
        }
        const base = window.location.origin;
        // rota relativa: /dre/:ano/:mes?
        const url = mes ? `/dre/${encodeURIComponent(ano)}/${encodeURIComponent(mes)}` : `/dre/${encodeURIComponent(ano)}`;
        try {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">Carregando...</td></tr>';
          const resp = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('Erro ao carregar DRE: ' + (txt || resp.statusText));
          }
          const json = await resp.json();
          // Caso a API retorne instância com métodos, JSON já terá só dados (linhas)
          renderDRE(json);
          // armazenar última resposta para exportação
          window.__lastDRE = json;
        } catch (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="4" class="empty">Erro ao carregar DRE. Veja console para detalhes.</td></tr>';
          alert(err.message || 'Erro desconhecido ao carregar DRE');
        }
      }

      // Exporta CSV simples baseado em window.__lastDRE
      function exportCSV(){
        const json = window.__lastDRE;
        if (!json || !Array.isArray(json.linhas) || json.linhas.length === 0){
          alert('Gere o DRE antes de exportar.');
          return;
        }

        const rows = [['Código','Descrição','Valor','Grupo']];
        json.linhas.forEach(l => {
          rows.push([ l.codigo || '', l.descricao || '', Number(l.valor || 0).toString(), l.grupo || '' ]);
        });

        const csv = rows.map(r => r.map(c => {
          // escapando aspas
          if (typeof c === 'string' && (c.includes(',') || c.includes('"') || c.includes('\n'))) {
            return '"' + c.replace(/"/g,'""') + '"';
          }
          return c;
        }).join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dre_${inputAno.value}${inputMes.value ? '_' + inputMes.value.padStart(2,'0') : ''}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Eventos
      btnGerar.addEventListener('click', () => fetchDRE(inputAno.value, inputMes.value || null));
      btnExport.addEventListener('click', exportCSV);

      // Se preferir, gera automaticamente ao abrir
      // fetchDRE(inputAno.value, inputMes.value || null);

    })();
  </script>

</body>
</html>
